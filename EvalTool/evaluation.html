<!DOCTYPE HTML>
<html lang = "en">
  <head>
    <title>Javascript Evaluation Tool</title>
    <meta charset = "UTF-8" />
    <link href="eval.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript">
      var questionsLen = 10;
      var userId = -1;
      var question = null;
      var pageLoads = 0;

      function nextLetter(s){
        return s.replace(/([a-zA-Z])[^a-zA-Z]*$/, function(a){
            var c= a.charCodeAt(0);
            switch(c){
                case 90: return 'A';
                case 122: return 'a';
                default: return String.fromCharCode(++c);
            }
        });
      }

      function loadQuestion() {
        var currentLetter = 'a';

        $("#radioAnswers").empty();

        $("#answers").fadeOut(500).promise().done(function() {
            $("#questionId").text("Question " + (question.questionId + 1) + "/" + questionsLen);
            $("#question").text(question.question);

            for(var i = 0; i < question.answers.length; i++) {
              $("#radioAnswers").append("<p><label><input id='answer"+i+"' type='radio' name='radio' value='"+i+"'> (" + currentLetter+ ") " + question.answers[i] + "</label></p>");
              currentLetter = nextLetter(currentLetter);
            }

            if(parseInt(question.userAnswerId) != -1)
              $("#answer" + question.userAnswerId).attr('checked', true);

            $("#answers").fadeIn(500);
        });
      }

      $(document).ready(function() {
        //Get the userId
        $.ajax({
          type: "POST",
          url: "/EvalTool/login",
          success: function(result) {
            userId = result.userId;
            question = result.question;

            loadQuestion();
          },
          error: function() {

            //TODO: Handle this error
          }
        });

        function submitButtonClick(next, successCallback) {
          //console.log(next + " " + currentQuestionId);
          return function() {
            if((question.questionId - 1 < 0 && !next)) {
              $("#prevButton", window.parent.document).prop('disabled', true);
              return;
            }

            if(question.questionId+1 > 0) {
              $("#prevButton", window.parent.document).prop('disabled', false);
            }

            if(question.questionId + 1 === questionsLen-1 && next) {
              $("#nextButton", window.parent.document).prop('value', 'Submission');
            }

            if(question.questionId - 1 === questionsLen-2 && !next) {
              $("#nextButton", window.parent.document).prop('value', 'Next Page');
            }

            if(question.questionId + 1 > questionsLen-1 && next) {
              $("#content").empty();

              $.ajax({
                url: "/EvalTool/page11.html",
                dataType: "html"
              }).done(function( responseHtml ) {
                $.ajax({
                  type: "POST",
                  url: "/EvalTool/submit",
                  data: {
                    userId: userId
                  },
                  success: function(result) {
                    $("#content").html(responseHtml);
                    var finalScoreText = "Your final score: " + result.correctAnswers + "/" + questionsLen;

                    $("#finalScore").text(finalScoreText);
                    $('input[name=message]').val(finalScoreText);
                  },
                  error: function() {
                    //TODO: Handle this error
                  }
                });
              });
              return;
            }

            //var answer = question.answers[$('input[name=radio]:checked', '#answers').val()];
            var answer = parseInt($('input[name=radio]:checked', '#answers').val());

            $.ajax({
              url: "/EvalTool/testing",
              dataType: "jsonp",
              data: {
                userId: userId,
                questionId: question.questionId,
                answer: answer,
                //Next button = 1, prev button = -1
                direction: next ? 1 : -1
              },
              success: function(result) {
                question = result.question;
                successCallback(result);
              },
              error: function() {
                //TODO: Handle this error
              }
            });
          }
        }

        $("#nextButton", window.parent.document).click(submitButtonClick(true, function(result) {
            loadQuestion();
        }));

        $("#prevButton", window.parent.document).click(submitButtonClick(false, function(result) {
            loadQuestion();
        }));
      });
    </script>
  </head>
  <body>
    <div id="content" style="margin-top:1%">
    <form class="quiz" id="answers" style="margin-left:2%;">
     <fieldset>
      <legend id="questionId"></legend>
      <p id="question"></p>
      <div id="radioAnswers"></div>
     </fieldset>
    </form>
    </div>
  </body>
</html>
