<!doctype html>
<html>
  <head>
    <title>Web Apps Chat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="css/chat.css">
    <script src="js/chat.js"></script>
    <script>
      var socket = io("http://localhost:3000");

      /**
      * The room Id of the room that the user is currently viewing
      */
      var roomIdViewing = -1;
      var rooms = [];

      /*rooms = [
        {
          id: 5,
          name: "pokemon",
          users: []
        }
      ];*/

      $(window).on('resize', function(){
        $('#messageBox').css( "width",($(window).width() - 113)+'px');
      });
      $(document).ready(function(){
        $('#messageBox').css( "width",($(window).width() - 113) +'px');
      });

      $(window).on('resize', function(){
        $('#rooms').css( "height",($(window).height() - 40) +'px');
      });

      $(document).keypress(function(e) {
        //Enter key pressed
        if(e.which == 13) {
          sendMessage();
        }
      });

      $(document).ready(function(){
        $('#rooms').css( "height",($(window).height() - 40) +'px');

        $("#submitMessageButton").click(function() {
          sendMessage();
        });
      });

      socket.on('message', function(data) {
        if(data.roomId === roomIdViewing) {
          $("#messages").append("<li>" + data.username + ": " + data.message + "</li>");
        }

        //Keep track of the messages the user should see
        //regardless of whether they're currently viewing
        //the room that this message is being sent to. That
        //way when they switch to this room, they will immediately
        //be shown these messages without having to poll the server
        for(var i = 0; i < rooms.length; i++) {
          if(rooms[i].id === data.roomId) {
            rooms[i].messages.push({
              userId: data.userId,
              username: data.username,
              message: data.message
            });
          }
        }
      });

      socket.on('join', function(data) {
        for(var i = 0; i < rooms.length; i++) {
          if(rooms[i].id === data.roomId) {
            var username = data.username;

            rooms[i].users.push({
              userId: data.userId,
              username: username
            });

            $("#users").append("<p>" + username + "</p>");
            break;
          }
        }
      });

      socket.on('me_joined', function(data) {
        roomIdViewing = data.roomId;
        $("#messages").html("");
        $("#users").html("");
        setChatUsers(data.roomData);
      });

    </script>
    <script src="js/login.js"></script>
  </head>
  <body>
    <div id="loginContainer">
      <div id="login">
        <p id="formTitle">User Login</p>
        <p id="error" class="error">Please fill in all fields.</p>
        <input type="text" class="form-control" id="usernameInput" placeholder="Username" value="andrew"><br>
        <input type="password" class="form-control" id="passwordInput" placeholder="Password" value="password"><br>
        <input type="text" class="form-control" id="roomInput" placeholder="Room" value="dragons"><br>
        <button id="loginButton" type="button" class="btn btn-primary btn-sm">Login</button>
        <button id="registerButton" type="button" class="btn btn-default btn-sm">Register</button>
      </div>
    </div>
    <div id="chatContainer">
      <div>
        <div id="message_container">
        <ul id="messages"></ul>
        </div>
    	  <div id="users">
    	  </div>
      </div>
      <div id="input_container">
        <div id="messageContainer">
          <input id="messageBox" autocomplete="off" /><button id="submitMessageButton">Send</button>
        </div>
      </div>
    </div>
  </body>
</html>
